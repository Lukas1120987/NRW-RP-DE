<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NRW RP DE – Reports</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f19;
      --panel: #111626;
      --accent: #5865F2;
      --accent2: #4752C4;
      --text: #f0f0f0;
      --muted: #9ca3af;
      --success-bg: rgba(72, 187, 120, 0.15);
      --success-border: #48bb78;
      --error-color: #ff6b6b;
    }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: rgba(17,22,38,0.9);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      border-bottom: 1px solid #1f2540;
    }
    header h1 {
      color: var(--accent);
      font-size: 1.25rem;
    }
    #userInfo {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    #userInfo img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    #loginBtn {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: .6rem 1.2rem;
      cursor: pointer;
      font-weight: 600;
      transition: .2s;
    }
    #loginBtn:hover {
      transform: scale(1.05);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .tabBtn {
      background: #151b2e;
      border: 1px solid #1e2440;
      color: var(--muted);
      border-radius: 8px;
      padding: .6rem 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: .2s;
    }
    .tabBtn.active,
    .tabBtn:hover {
      color: var(--accent);
      border-color: var(--accent);
    }
    .panel {
      background: var(--panel);
      border-radius: 12px;
      padding: 2rem;
      max-width: 650px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0,0,0,.3);
      opacity: 0;
      visibility: hidden;
      transition: opacity .3s, visibility .3s;
    }
    .panel.active {
      opacity: 1;
      visibility: visible;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    input, textarea, select {
      background: #0f1324;
      border: 1px solid #1e2440;
      border-radius: 8px;
      color: var(--text);
      padding: .75rem;
      font-family: inherit;
      width: 100%;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .dropzone {
      border: 2px dashed var(--accent);
      border-radius: 10px;
      text-align: center;
      padding: 1.5rem;
      color: var(--muted);
      transition: .3s;
      cursor: pointer;
    }
    .dropzone.dragover {
      background: rgba(88,101,242,0.1);
      border-color: #8a95ff;
      color: #c7cbff;
    }
    button.submit {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border: none;
      border-radius: 8px;
      padding: .8rem;
      font-weight: 600;
      cursor: pointer;
      transition: .2s;
    }
    button.submit:hover {
      transform: translateY(-2px);
    }
    .success {
      text-align: center;
      background: var(--success-bg);
      border: 1px solid var(--success-border);
      padding: .8rem;
      border-radius: 8px;
      font-size: 1.1rem;
      display: none;
      margin-top: 1rem;
      opacity: 0;
      transition: opacity .5s;
    }
    .success.show {
      display: block;
      opacity: 1;
    }
    .error-message {
      color: var(--error-color);
      font-size: 0.9rem;
    }
    .file-preview {
      font-size: 0.9rem;
      color: var(--muted);
    }
    @media (max-width:600px) {
      .panel { padding:1rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>NRW RP DE – Reports</h1>
  <div id="userInfo">
    <button id="loginBtn">Mit Discord anmelden</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tabBtn active" data-tab="discord">Discord Report</button>
    <button class="tabBtn" data-tab="roblox">Roblox Report</button>
  </div>

  <div class="panel active" id="discord">
    <form id="discordForm">
      <input type="text" id="discordReporter" placeholder="Dein Discord-Name" required>
      <input type="text" id="discordTarget" placeholder="Gemeldeter User (Name#0000)" required>
      <select id="discordType" required>
        <option value="">Art des Verstoßes</option>
        <option value="beleidigung">Beleidigung</option>
        <option value="spam">Spam / Werbung</option>
        <option value="cheating">Cheating / Exploits</option>
        <option value="sonstiges">Sonstiges</option>
      </select>
      <textarea id="discordReason" placeholder="Grund des Reports ..." required></textarea>

      <div class="dropzone" id="dropDiscord">Ziehe Beweise hierher oder klicke, um Dateien auszuwählen (max. 3)</div>
      <input type="file" id="discordFiles" multiple accept="image/*" style="display:none">
      <div class="file-preview" id="previewDiscord"></div>

      <button type="submit" class="submit" id="btnDiscord">Absenden</button>
      <div class="success" id="successDiscord">Dein Report wurde gesendet!</div>
    </form>
  </div>

  <div class="panel" id="roblox">
    <form id="robloxForm">
      <input type="text" id="robloxReporter" placeholder="Dein Roblox-Name" required>
      <input type="text" id="robloxTarget" placeholder="Gemeldeter User" required>
      <select id="robloxType" required>
        <option value="">Art des Verstoßes</option>
        <option value="beleidigung">Beleidigung</option>
        <option value="spam">Spam / Werbung</option>
        <option value="cheating">Cheating / Exploits</option>
        <option value="sonstiges">Sonstiges</option>
      </select>
      <textarea id="robloxReason" placeholder="Grund des Reports ..." required></textarea>

      <div class="dropzone" id="dropRoblox">Ziehe Beweise hierher oder klicke, um Dateien auszuwählen (max. 3)</div>
      <input type="file" id="robloxFiles" multiple accept="image/*" style="display:none">
      <div class="file-preview" id="previewRoblox"></div>

      <button type="submit" class="submit" id="btnRoblox">Absenden</button>
      <div class="success" id="successRoblox">Dein Report wurde gesendet!</div>
    </form>
  </div>

  <div class="appeals">
    <a href="https://lukas1120987.github.io/NRW-RP-DE/appeal_ingame.html">Ingame Ban Appeal</a>
    <a href="https://lukas1120987.github.io/NRW-RP-DE/appeal_discord.html">Discord Ban Appeal</a>
  </div>
</main>

<script>
// --- Tab Switching mit Fade ---
document.querySelectorAll(".tabBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    const panel = document.getElementById(btn.dataset.tab);
    panel.classList.add("active");
  });
});

// --- Discord Login ---
const loginBtn = document.getElementById("loginBtn");
const userInfo = document.getElementById("userInfo");
const DISCORD_CLIENT_ID = "1426800191591415848";
const REDIRECT_URI = "https://lukas1120987.github.io/NRW-RP-DE/report.html";

const urlParams = new URLSearchParams(window.location.hash.substring(1));
const accessToken = urlParams.get("access_token");

if (accessToken) {
  fetch("https://discord.com/api/users/@me", {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(r => r.json())
  .then(user => {
    localStorage.setItem("discordUser", JSON.stringify(user));
    showUser(user);
  });
} else {
  const saved = localStorage.getItem("discordUser");
  if (saved) showUser(JSON.parse(saved));
}

loginBtn.addEventListener("click", () => {
  window.location.href =
    `https://discord.com/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;
});

function showUser(user) {
  userInfo.innerHTML = `
    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64" alt="Profilbild">
    <span>${user.username}#${user.discriminator}</span>
  `;
  document.getElementById("discordReporter").value = `${user.username}#${user.discriminator}`;
}

// --- Drag & Drop + Vorschau ---
function setupDrop(dropId, fileInputId, previewId) {
  const drop = document.getElementById(dropId);
  const fileInput = document.getElementById(fileInputId);
  const preview = document.getElementById(previewId);

  function showPreview(files) {
    if (!files || files.length === 0) {
      preview.textContent = "";
      return;
    }
    const names = [...files].map(f => f.name);
    preview.innerHTML = names.join("<br>");
  }

  drop.addEventListener("click", () => fileInput.click());
  drop.addEventListener("dragover", e => {
    e.preventDefault();
    drop.classList.add("dragover");
  });
  drop.addEventListener("dragleave", () => drop.classList.remove("dragover"));
  drop.addEventListener("drop", e => {
    e.preventDefault();
    drop.classList.remove("dragover");
    fileInput.files = e.dataTransfer.files;
    showPreview(fileInput.files);
  });
  fileInput.addEventListener("change", () => showPreview(fileInput.files));
}
setupDrop("dropDiscord", "discordFiles", "previewDiscord");
setupDrop("dropRoblox", "robloxFiles", "previewRoblox");

// --- Validation & Rate Limiting ---
function validDiscordTag(name) {
  return test(name);
}

function tooSoon() {
  const last = parseInt(localStorage.getItem("lastReportTime") || "0", 10);
  // 60 Sekunden Sperre
  return (Date.now() - last) < 60000;
}
function markSent() {
  localStorage.setItem("lastReportTime", Date.now().toString());
}

// --- Webhook Upload & Handling ---
const WEBHOOK = "https://discord.com/api/webhooks/1431362730652205206/knBHTnkaX0VSpeynEzjV5mjYvvvsVnuudlbKnNREHErrtbVNNOoeWFfVTcCD3yLUS_d9";

async function sendReport(type, fields, files, successEl, btnEl) {
  // Validierungen
  if (!fields.reporter.trim() || !fields.target.trim() || !fields.reason.trim() || !fields.category) {
    alert("Bitte fülle alle Felder aus.");
    return;
  }
  if (type === "Discord" && !validDiscordTag(fields.target)) {
    alert("Bitte gib einen gültigen Discord-Namen ein (z. B. Name#1234).");
    return;
  }
  if (tooSoon()) {
    alert("Bitte warte eine Minute, bevor du erneut meldest.");
    return;
  }

  btnEl.disabled = true;
  const origText = btnEl.textContent;
  btnEl.textContent = "Senden...";

  const formData = new FormData();
  let content = `**${type} Report**\n`;
  content += `Reporter: ${fields.reporter}\n`;
  content += `Gemeldeter User: ${fields.target}\n`;
  content += `Kategorie: ${fields.category}\n`;
  content += `Grund: ${fields.reason}`;
  formData.append("content", content);

  if (files) {
    for (let i = 0; i < Math.min(files.length, 3); i++) {
      formData.append(`file${i+1}`, files[i]);
    }
  }

  try {
    const resp = await fetch(WEBHOOK, { method: "POST", body: formData });
    if (resp.ok) {
      successEl.classList.add("show");
      markSent();
      setTimeout(() => {
        successEl.classList.remove("show");
      }, 4000);
    } else {
      alert("Fehler beim Senden");
    }
  } catch (err) {
    console.error(err);
    alert("Fehler beim Senden");
  } finally {
    btnEl.disabled = false;
    btnEl.textContent = origText;
  }
}

// --- Form Submissions ---
document.getElementById("discordForm").addEventListener("submit", e => {
  e.preventDefault();
  const btn = document.getElementById("btnDiscord");
  sendReport("Discord", {
    reporter: discordReporter.value,
    target: discordTarget.value,
    reason: discordReason.value,
    category: discordType.value
  }, discordFiles.files, successDiscord, btn);
  e.target.reset();
});

document.getElementById("robloxForm").addEventListener("submit", e => {
  e.preventDefault();
  const btn = document.getElementById("btnRoblox");
  sendReport("Roblox", {
    reporter: robloxReporter.value,
    target: robloxTarget.value,
    reason: robloxReason.value,
    category: robloxType.value
  }, robloxFiles.files, successRoblox, btn);
  e.target.reset();
});
</script>

</body>
</html>
