<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teamkontakt & Live-Support</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0d1117;
    color: #e6edf3;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-top: 50px;
  }
  .container {
    width: 90%;
    max-width: 650px;
    background: #161b22;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px #000;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #58a6ff;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  select, textarea, input {
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border: none;
    border-radius: 8px;
    background: #21262d;
    color: #e6edf3;
    font-size: 16px;
    resize: vertical;
  }
  select:focus, textarea:focus, input:focus {
    outline: 2px solid #58a6ff;
  }
  button {
    width: 100%;
    margin-top: 20px;
    padding: 15px;
    border: none;
    border-radius: 8px;
    background: #238636;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover { background: #2ea043; }
  .success, .error {
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    display: none;
  }
  .success { background: #238636; }
  .error { background: #da3633; }
  #loginStatus {
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
    font-weight: bold;
  }
  #liveSupport {
    margin-top: 25px;
    padding: 20px;
    background: #1a1d2b;
    border-radius: 12px;
    text-align: center;
    display: none;
  }
  #liveSupport a {
    display: inline-block;
    margin-top: 10px;
    padding: 12px 20px;
    background: #5865F2;
    color: #fff;
    border-radius: 8px;
    font-weight: bold;
    text-decoration: none;
    transition: 0.2s;
  }
  #liveSupport a:hover { background: #4752C4; }
  #ticketID {
    font-weight: bold;
    margin-top: 10px;
    color: #58a6ff;
  }
  #ticketStatus {
    margin-top: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #f0ad4e;
  }
  footer {
    margin-top: 20px;
    text-align: center;
    font-size: 13px;
    color: #8b949e;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Teamkontakt & Tickets</h1>

  <div id="loginStatus">üîê Nicht eingeloggt</div>
  <button id="loginBtn" onclick="loginWithDiscord()">üîë Mit Discord anmelden</button>

  <label for="category">Kategorie</label>
  <select id="category" onchange="checkLoginRequired()">
    <option value="" disabled selected>Bitte ausw√§hlen</option>
    <option value="feedback">üí° Feedback</option>
    <option value="support">üõ†Ô∏è Support</option>
    <option value="bug">üêõ Bugreport</option>
    <option value="bewerbung">üì® Bewerbung / Kontakt</option>
  </select>

  <div id="loginNotice" style="display:none; margin-top:10px; color:#da3633; font-weight:bold;">
    ‚ö†Ô∏è Diese Kategorie erfordert einen Discord-Login.
  </div>

  <label for="title">Titel</label>
  <input type="text" id="title" placeholder="Kurzer Titel f√ºr dein Anliegen">

  <label for="message">Nachricht</label>
  <textarea id="message" rows="6" placeholder="Beschreibe dein Anliegen hier..."></textarea>

  <button onclick="sendTicket()">üì© Ticket absenden</button>

  <div id="success" class="success">‚úÖ Ticket erfolgreich gesendet!</div>
  <div id="error" class="error">‚ùå Fehler beim Senden. Bitte versuche es erneut.</div>

  <div id="liveSupport">
    <h2>üí¨ Live-Support</h2>
    <p>Dein Ticket wurde erstellt! Du kannst direkt im Discord-Channel weiter chatten:</p>
    <div id="ticketID"></div>
    <div id="ticketStatus">Erstellt</div>
    <a href="https://discord.com/channels/ServerID/ChannelID" target="_blank">Zum Live-Support</a>
  </div>

  <footer>Powered by Discord Webhooks üöÄ</footer>
</div>

<script>
const CLIENT_ID = "1391061610445017178";
const REDIRECT_URI = "https://lukas1120987.github.io/NRW-RP-DE/teamkontakt.html";

const WEBHOOKS = {
  feedback: "https://discord.com/api/webhooks/1421935742539534376/xI5-rZtA2uLb0ylZqbQzvlRcg-kwhp3LqRq3hmuv0dCq9Js3Pn7_pcVy9yrse7NxR-hN",
  support: "https://discord.com/api/webhooks/1421935803893813268/pJwD0Uy2BwyuDTrMG-DPCABY6iyoZpqeMVkdwJuESOQQP9BPxTuER-_fBSIaLgRw3KtO",
  bug: "https://discord.com/api/webhooks/1421935775234392224/IACaAMfMx56aAVg5E45weKvGHOJhVluH7h3joY9wpPO9p91f9UCJgMfkN0F9yY65plnW",
  bewerbung: "https://discord.com/api/webhooks/1421935708192510073/XM46_ZJhWs9Qjgy2ZW_8SYWqFzRgtOZe_pb0NfT9KKLMDhV57719aD_uh3sprXr9ZPgf"
};

const loginRequiredCategories = ["support","bug","bewerbung"];
let accessToken = null;
let discordUser = null;

// Discord-Login
function loginWithDiscord() {
  window.location.href = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;
}

// Token aus URL extrahieren
window.addEventListener("load", async () => {
  if(window.location.hash.includes("access_token")){
    accessToken = window.location.hash.match(/access_token=([^&]+)/)?.[1];
    localStorage.setItem("discord_logged_in","true");
    localStorage.setItem("discord_token",accessToken);
    window.location.hash = "#login-success";
  } else if(window.location.hash === "#login-success" || localStorage.getItem("discord_logged_in")==="true"){
    accessToken = localStorage.getItem("discord_token");
  }

  if(accessToken){
    try {
      const res = await fetch("https://discord.com/api/users/@me", {headers: {"Authorization": "Bearer "+accessToken}});
      discordUser = await res.json();
      document.getElementById("loginStatus").innerText = `‚úÖ Eingeloggt als ${discordUser.username}#${discordUser.discriminator}`;
      document.getElementById("loginBtn").style.display = "none";
    } catch(e){
      console.error("Fehler beim Abrufen der Discord-Daten");
    }
  }
});

function checkLoginRequired(){
  const category = document.getElementById("category").value;
  document.getElementById("loginNotice").style.display = loginRequiredCategories.includes(category) ? "block" : "none";
}

// Ticketnummer generieren
function generateTicketID(){
  const now = new Date();
  return `#${now.getFullYear()}-${Math.floor(Math.random()*9000+1000)}`;
}

// Ticket senden
async function sendTicket(){
  const category = document.getElementById("category").value;
  const title = document.getElementById("title").value;
  const message = document.getElementById("message").value;

  if(!category || !title || !message){ showError("Bitte f√ºlle alle Felder aus."); return; }
  if(loginRequiredCategories.includes(category) && !discordUser){ showError("Bitte melde dich zuerst √ºber Discord an."); return; }

  const webhookURL = WEBHOOKS[category];
  if(!webhookURL){ showError("Webhook f√ºr diese Kategorie ist nicht definiert."); return; }

  const ticketID = generateTicketID();

  const embed = {
    username: "Teamkontakt",
    avatar_url: "https://cdn-icons-png.flaticon.com/512/5968/5968756.png",
    embeds:[{
      title:`üì© Neues ${capitalize(category)}-Ticket ${ticketID}`,
      color: categoryColor(category),
      fields:[
        {name:"üìå Titel", value:title},
        {name:"‚úâÔ∏è Nachricht", value:message},
        {name:"üë§ Absender", value: discordUser ? `${discordUser.username}#${discordUser.discriminator}` : "Anonym"},
        {name:"üìÖ Eingegangen", value: new Date().toLocaleString("de-DE")}
      ]
    }]
  };

  try{
    const res = await fetch(webhookURL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(embed)
    });
    if(res.ok){
      showSuccess();
      document.getElementById("title").value="";
      document.getElementById("message").value="";
      document.getElementById("category").value="";
      document.getElementById("liveSupport").style.display="block";
      document.getElementById("ticketID").innerText = ticketID;
      document.getElementById("ticketStatus").innerText = "Erstellt";
      document.getElementById("liveSupport").scrollIntoView({behavior:"smooth"});
    } else throw new Error();
  } catch(e){ showError("Fehler beim Senden an Discord."); }
}

function categoryColor(cat){
  switch(cat){
    case "feedback": return 0x58a6ff;
    case "support": return 0x2ea043;
    case "bug": return 0xda3633;
    case "bewerbung": return 0xf39c12;
    default: return 0x5865F2;
  }
}
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
function showSuccess(){ document.getElementById("success").style.display="block"; document.getElementById("error").style.display="none"; }
function showError(msg){ const err = document.getElementById("error"); err.innerText="‚ùå "+msg; err.style.display="block"; document.getElementById("success").style.display="none"; }
</script>
</body>
</html>
