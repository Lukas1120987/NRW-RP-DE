<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teamkontakt & Tickets</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0d1117;
    color: #e6edf3;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
  }
  .container {
    width: 90%;
    max-width: 600px;
    background: #161b22;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px #000;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #58a6ff;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  select, textarea, input {
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border: none;
    border-radius: 8px;
    background: #21262d;
    color: #e6edf3;
    font-size: 16px;
    resize: vertical;
  }
  select:focus, textarea:focus, input:focus {
    outline: 2px solid #58a6ff;
  }
  button {
    width: 100%;
    margin-top: 25px;
    padding: 15px;
    border: none;
    border-radius: 8px;
    background: #238636;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover { background: #2ea043; }
  .success, .error {
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    display: none;
  }
  .success { background: #238636; }
  .error { background: #da3633; }
  footer {
    margin-top: 20px;
    text-align: center;
    font-size: 13px;
    color: #8b949e;
  }
  #discordLogin {
    margin-top: 10px;
    padding: 12px;
    background: #5865F2;
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 100%;
    font-size: 16px;
    cursor: pointer;
  }
  #userInfo {
    margin-top: 10px;
    padding: 10px;
    background: #21262d;
    border-radius: 8px;
    text-align: center;
    display: none;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Teamkontakt & Tickets</h1>

  <label for="category">Kategorie</label>
  <select id="category" onchange="checkLoginRequired()">
    <option value="" disabled selected>Bitte ausw√§hlen</option>
    <option value="feedback">üí° Feedback</option>
    <option value="support">üõ†Ô∏è Support</option>
    <option value="bug">üêõ Bugreport</option>
    <option value="bewerbung">üì® Sonstiges</option>
  </select>

  <div id="loginNotice" style="display:none; margin-top:10px; color:#da3633; font-weight:bold;">
    ‚ö†Ô∏è Diese Kategorie erfordert einen Discord-Login.
  </div>

  <button id="discordLogin" style="display:none;" onclick="redirectToDiscord()">üîê Mit Discord anmelden</button>
  <div id="userInfo"></div>

  <label for="title">Titel</label>
  <input type="text" id="title" placeholder="Kurzer Titel f√ºr dein Anliegen">

  <label for="message">Nachricht</label>
  <textarea id="message" rows="6" placeholder="Beschreibe dein Anliegen hier..."></textarea>

  <button onclick="sendTicket()">üì© Ticket absenden</button>

  <div id="success" class="success">‚úÖ Ticket erfolgreich gesendet!</div>
  <div id="error" class="error">‚ùå Fehler beim Senden. Bitte versuche es erneut.</div>

  <footer>Powered by Discord Webhooks üöÄ</footer>
</div>

<script>
const WEBHOOKS = {
  feedback: "https://discord.com/api/webhooks/1421935742539534376/xI5-rZtA2uLb0ylZqbQzvlRcg-kwhp3LqRq3hmuv0dCq9Js3Pn7_pcVy9yrse7NxR-hN",
  support: "https://discord.com/api/webhooks/1421935803893813268/pJwD0Uy2BwyuDTrMG-DPCABY6iyoZpqeMVkdwJuESOQQP9BPxTuER-_fBSIaLgRw3KtO",
  bug: "https://discord.com/api/webhooks/1421935775234392224/IACaAMfMx56aAVg5E45weKvGHOJhVluH7h3joY9wpPO9p91f9UCJgMfkN0F9yY65plnW",
  bewerbung: "https://discord.com/api/webhooks/1421935708192510073/XM46_ZJhWs9Qjgy2ZW_8SYWqFzRgtOZe_pb0NfT9KKLMDhV57719aD_uh3sprXr9ZPgf"
};

// Kategorien mit Loginpflicht
const loginRequiredCategories = ["support", "bug", "bewerbung"];

let discordUser = null;

// --- OAuth-Check (Implicit Grant Flow) ---
window.addEventListener("DOMContentLoaded", async () => {
  const hash = window.location.hash;
  if (hash.includes("access_token")) {
    const params = new URLSearchParams(hash.replace("#", ""));
    const token = params.get("access_token");
    if (token) {
      try {
        const res = await fetch("https://discord.com/api/users/@me", {
          headers: { Authorization: "Bearer " + token }
        });
        const user = await res.json();
        discordUser = user;
        document.getElementById("userInfo").style.display = "block";
        document.getElementById("userInfo").innerText = `üë§ Eingeloggt als ${user.username}#${user.discriminator}`;
        document.getElementById("discordLogin").style.display = "none";
        history.replaceState(null, "", window.location.pathname); // Hash entfernen
      } catch (e) {
        console.error("Discord Login fehlgeschlagen");
      }
    }
  }
});

// Loginpflicht pr√ºfen
function checkLoginRequired() {
  const category = document.getElementById("category").value;
  if (loginRequiredCategories.includes(category)) {
    document.getElementById("loginNotice").style.display = "block";
    if (!discordUser) document.getElementById("discordLogin").style.display = "block";
  } else {
    document.getElementById("loginNotice").style.display = "none";
    document.getElementById("discordLogin").style.display = "none";
  }
}

// Weiterleitung zu Discord
function redirectToDiscord() {
  const clientId = "1391061610445017178";
  const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
  const scope = "identify";
  window.location.href = `https://discord.com/oauth2/authorize?client_id=${clientId}&response_type=token&redirect_uri=${redirectUri}&scope=${scope}`;
}

// Ticket senden
async function sendTicket() {
  const category = document.getElementById("category").value;
  const title = document.getElementById("title").value;
  const message = document.getElementById("message").value;

  if (!category || !title || !message) return showError("Bitte f√ºlle alle Felder aus.");
  if (loginRequiredCategories.includes(category) && !discordUser) return showError("Bitte melde dich zuerst √ºber Discord an.");

  const webhookURL = WEBHOOKS[category];
  if (!webhookURL) return showError("Webhook f√ºr diese Kategorie ist nicht definiert.");

  const embed = {
    username: "Kontaktformular",
    avatar_url: "https://cdn-icons-png.flaticon.com/512/5968/5968756.png",
    embeds: [{
      title: `üì© Neues ${capitalize(category)}-Ticket`,
      color: categoryColor(category),
      fields: [
        { name: "üìå Titel", value: title },
        { name: "‚úâÔ∏è Nachricht", value: message },
        { name: "üë§ Absender", value: discordUser ? `${discordUser.username}#${discordUser.discriminator}` : "Anonym" },
        { name: "üìÖ Eingegangen", value: new Date().toLocaleString("de-DE") }
      ]
    }]
  };

  try {
    const res = await fetch(webhookURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(embed)
    });
    if (res.ok) {
      showSuccess();
      document.getElementById("title").value = "";
      document.getElementById("message").value = "";
      document.getElementById("category").value = "";
    } else throw new Error();
  } catch (err) {
    showError("Fehler beim Senden an Discord.");
  }
}

function categoryColor(cat) {
  switch (cat) {
    case "feedback": return 0x58a6ff;
    case "support": return 0x2ea043;
    case "bug": return 0xda3633;
    case "bewerbung": return 0xf39c12;
    default: return 0x5865F2;
  }
}
function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
function showSuccess() {
  document.getElementById("success").style.display = "block";
  document.getElementById("error").style.display = "none";
}
function showError(msg) {
  const err = document.getElementById("error");
  err.innerText = "‚ùå " + msg;
  err.style.display = "block";
  document.getElementById("success").style.display = "none";
}
</script>
</body>
</html>
